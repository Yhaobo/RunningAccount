<!DOCTYPE html>
<html lang="zh">
<head>
    <!--设置字符编码-->
    <meta charset="UTF-8">
    <title>收支明细</title>

    <link href="static/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css"/>
    <link href="static/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="static/css/global.css" rel="stylesheet" type="text/css"/>


</head>
<body>
<header id="header"></header>
<!--列表-->
<table id="table"></table>

<!-- Modal -->
<div class="modal fade " id="modal" tabindex="-1" role="dialog" aria-labelledby="modalTitle">
    <div class="modal-dialog modal-slg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="modalTitle"></h4>
            </div>
            <div class="modal-body">
                <form id="form" action="javascript:;">
                    <input type="hidden" name="id" value="0" id="hidden_id"/>
                    <input type="hidden" name="date" id="hidden_date"/>
                    <table class="table table-hover table-bordered">
                        <tr>
                            <th>日期</th>
                            <th>摘要</th>
                            <th>项目</th>
                            <th>账户</th>
                            <th>部门</th>
                            <th>分类</th>
                            <th>收入</th>
                            <th>支出</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="datetime-local" class="form-control" id="date">
                            </td>
                            <td>
                                <input type="text" class="form-control" id="description" placeholder="摘要"
                                       name="description">
                            </td>
                            <td>
                                <select class="form-control" name="project.id" id="project">
                                </select>
                            </td>
                            <td>
                                <select class="form-control" name="account.id" id="account">
                                </select>
                            </td>
                            <td>
                                <select class="form-control" name="department.id" id="department">
                                </select>
                            </td>
                            <td>
                                <select class="form-control" name="category.id" id="category">
                                </select>
                            </td>
                            <td><input type="number" class="form-control" id="earning" placeholder="收入" name="earning">
                            </td>
                            <td><input type="number" class="form-control" id="expense" placeholder="支出" name="expense">
                            </td>

                        </tr>
                    </table>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="submit">提交</button>
                <button type="submit" class="btn btn-danger hidden " id="delete">删除</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<!--    注意: 要先导入jquery的js文件, 再导入bootstrap的js文件-->
<script src="static/js/jquery-3.4.1.min.js"></script>
<script src="static/bootstrap/js/bootstrap.min.js"></script>
<script src="static/js/util.js"></script>
<script src="static/js/load.js"></script>
<script>

    init();

    function init() {
        $.get("detail/getAll", function (data) {
            if (data.flag) {
                var html = '<caption>收支明细</caption><tr>\n' +
                    '            <th>日期</th>\n' +
                    '            <th>摘要</th>\n' +
                    '            <th>项目</th>\n' +
                    '            <th>账户</th>\n' +
                    '            <th>部门</th>\n' +
                    '            <th>分类</th>\n' +
                    '            <th>收入</th>\n' +
                    '            <th>支出</th>\n' +
                    '            <th>结存</th>\n' +
                    '            <th>操作</th>\n' +
                    '        </tr>';
                for (var i = 0; i < data.data.length; i++) {
                    var detail = data.data[i];
                    html += ' <tr>\n' +
                        '            <td>' + dateFormat(new Date(detail.date), "yyyy-MM-dd") + '</td>\n' +
                        '            <td>' + detail.description + '</td>\n' +
                        '            <td>' + detail.project.name + '</td>\n' +
                        '            <td>' + detail.account.name + '</td>\n' +
                        '            <td>' + detail.department.name + '</td>\n' +
                        '            <td>' + detail.category.name + '</td>\n' +
                        '            <td>' + detail.formatEarning + '</td>\n' +
                        '            <td>' + detail.formatExpense + '</td>\n' +
                        '            <td>' + detail.formatBalance + '</td>\n' +
                        '            <td><a href="javascript:;" style="display: block" onclick="edit(' + detail.id + ')">修改</a></td>\n' +
                        '      </tr>'
                }
                $("#table").html(html).addClass("table-hover");
            } else {
                location.href = "index.html";
            }
        });
    }


    //修改
    function edit(id) {
        $("#modalTitle").text("修改");
        //数据回显
        loadDetail(id);
        $("#delete").removeClass("hidden");
        $('#modal').modal({
            show: true,
            backdrop: false
        });
        //添加点击事件
        submit("update");
        submit("delete");
    }

    //添加记录
    function add() {
        $("#modalTitle").text("添加");
        // 自动获取当前日期
        $("#date").val(dateFormat(new Date(), "yyyy-MM-ddTHH:mm"));
        loadSelects();
        if (!$("#delete").hasClass("hidden")) {
            $("#delete").addClass("hidden");
        }
        $('#modal').modal({
            show: true,
            backdrop: false
        });
        //添加点击事件(添加)
        submit("add");
    }

    let project;
    let account;
    let category;
    let department;

    //表单数据回显
    function loadDetail(id) {
        $.get("detail/findOne", {"id": id}, function (data) {
            if (data.flag) {
                $("#date").val(dateFormat(new Date(data.data.date), "yyyy-MM-ddTHH:mm"));
                $("#description").val(data.data.description);
                $("#earning").val(data.data.earning);
                $("#expense").val(data.data.expense);

                project = data.data.project;
                account = data.data.account;
                category = data.data.category;
                department = data.data.department;

                $("#hidden_id").val(id);
                loadSelects();
            } else {
                location.href = "index.html";
            }
        });
    }

    //加载所有选项
    function loadSelects() {
        //获取所有项目
        $.get("setting/findProjects", function (data) {
            if (!data.flag) {
                location.href = "index.html";
            }
            var html = '<option>--请选择项目--</option>';
            if (data.data.length == 1) {
                html = '';
            }
            for (var i = 0; i < data.data.length; i++) {
                var option = data.data[i];
                if (project && option.id == project.id) {
                    html += '<option value="' + option.id + '" selected>' + option.name + '</option>';
                } else {
                    html += '<option value="' + option.id + '">' + option.name + '</option>';
                }
            }
            $("#project").html(html);
        });

        //获取所有账户
        $.get("setting/findAccounts", function (data) {
            if (!data.flag) {
                location.href = "index.html";
            }
            let html = '<option>--请选择账户--</option>';
            if (data.data.length == 1) {
                html = '';
            }
            for (var i = 0; i < data.data.length; i++) {
                var option = data.data[i];
                if (account && option.id == account.id) {
                    html += '<option value="' + option.id + '" selected>' + option.name + '</option>';
                } else {
                    html += '<option value="' + option.id + '">' + option.name + '</option>';
                }
            }
            $("#account").html(html);
        });
        //获取所有分类
        $.get("setting/findCategorys", function (data) {
            if (!data.flag) {
                location.href = "index.html";
            }
            let html = '<option>--请选择分类--</option>';
            if (data.data.length == 1) {
                html = '';
            }
            for (var i = 0; i < data.data.length; i++) {
                var option = data.data[i];
                if (category && option.id == category.id) {
                    html += '<option value="' + option.id + '" selected>' + option.name + '</option>';
                } else {
                    html += '<option value="' + option.id + '">' + option.name + '</option>';
                }
            }
            $("#category").html(html);
        });
        //获取所有部门
        $.get("setting/findDepartments", function (data) {
            if (!data.flag) {
                location.href = "index.html";
            }
            let html = '<option>--请选择部门--</option>';
            if (data.data.length == 1) {
                html = '';
            }
            for (var i = 0; i < data.data.length; i++) {
                var option = data.data[i];
                if (department && option.id == department.id) {
                    html += '<option value="' + option.id + '" selected>' + option.name + '</option>';
                } else {
                    html += '<option value="' + option.id + '">' + option.name + '</option>';
                }
            }
            $("#department").html(html);
        });
    }

    //表单提交
    function submit(method) {
        let button = "submit";
        let msg = "提交?";
        if (method == "delete") {
            button = "delete";
            msg = "删除!!!!!!!???????";
        }
        $("#" + button).off().click(function () {
            if (!confirm("确认" + msg)) {
                return;
            }
            $('#modal').modal('hide');
            //改时间格式
            var datetime = dateFormat(new Date($("#date").val()), "yyyy-MM-dd HH:mm");
            $("#hidden_date").val(datetime);

            $.post("detail/" + method, $("#form").serialize(), function (data) {
                if (data.flag) {
                    $("#form")[0].reset();
                    init();
                } else {
                    alert(data.message);
                }
            });
        });
    }


</script>
</body>
</html>
